name: üê≥ Build and Push Docker Image

on:
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 1) Disparador manual desde GitHub Actions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  workflow_dispatch:      # Allows manual execution of the workflow
    inputs:
      create_release:
        description: "Create Release ?"
        type: boolean
        required: false
        default: false
      final_release:
        description: "Is this a Final Release?"
        required: false
        default: false
        type: boolean

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 2) Disparador  desde otro workflow ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  workflow_call:          # Allow to call this workflow from another workflow
    inputs:
      final_release:
        description: "Is this a Final Release?"
        required: false
        default: false
        type: boolean
    secrets:
      DOCKERHUB_USER:
        required: true
      DOCKERHUB_PASSWORD:
        required: true

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 3) Disparador autom√°tico por push ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  push:                   # Ejecuci√≥n tras push en cualquier rama, excepto en los path-ignore
    branches:
      - main             # Ejecuci√≥n tras push en main, excepto en los path-ignore
      # - development      # Ejecuci√≥n tras push en developer, excepto en los path-ignore
    paths-ignore:
      - .gitignore
      - .idea/**
      - gpth*/**
      - README.md

  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 4) Disparador autom√°tico por cron ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  #  schedule:
  #    - cron: '0 2 * * *' # Ejecuci√≥n diaria a las 2 AM UTC
  # ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

jobs:
  build:
    strategy:
      matrix:
#        os: [ubuntu-latest, windows-latest]  # os list
        os: [ubuntu-latest]  # os list
        python-version: [ "3.12.10" ]

    runs-on: ${{ matrix.os }}

    steps:
      # üßæ Checkout Repository
      - name: üßæ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ github.token }}

      # üè∑Ô∏è Extract TOOL_VERSION from SSB_RetuningAutomations.py
      - name: üè∑Ô∏è Extract TOOL_VERSION from SSB_RetuningAutomations.py
        shell: bash
        run: |
          TOOL_VERSION=$(grep -oP "^TOOL_VERSION\s*=\s*\"\K[^\"]+" ./src/SSB_RetuningAutomations.py)
          echo "TOOL_VERSION=${TOOL_VERSION}" >> $GITHUB_ENV
          echo "TOOL_VERSION: ${TOOL_VERSION}"

      # Generate the Docker version
      # ===========================
      - name: Check DockerHub secrets
        shell: bash
        run: |
          if [ -z "${{ secrets.DOCKERHUB_USER }}" ]; then
            echo "DOCKERHUB_USER is empty"
            exit 1
          fi
          if [ -z "${{ secrets.DOCKERHUB_PASSWORD }}" ]; then
            echo "DOCKERHUB_PASSWORD is empty"
            exit 1
          fi

      # üê≥ Log in to Docker Hub
      - name: üê≥ Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USER }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}

      # üê≥ Build & Push Docker image
      - name: üê≥ Build & Push Docker image
        if: ${{ startsWith(matrix.os, 'ubuntu') }}
        run: |
          # Define FINAL_RELEASE=false con fallback si est√° vac√≠o (por ejemplo, en eventos push)
          FINAL_RELEASE="${{ inputs.final_release }}"
          FINAL_RELEASE=${FINAL_RELEASE:-false}
      
          echo "‚Üí FINAL_RELEASE = $FINAL_RELEASE"
          
          # Fuerza a Docker a:
          #  1) descargar la base actualizada ( --pull )
          #  2) ignorar todas las capas cacheadas ( --no-cache )
          docker build --pull --no-cache \
                -t jaimetur/ssb-retuning-automations:${TOOL_VERSION} \
                -f docker/Dockerfile .
          
          # Push siempre etiqueta obligatoria con la versi√≥n
          docker push jaimetur/ssb-retuning-automations:${TOOL_VERSION}
          
          # Push 'latest' if final_release is false OR it's alpha/beta/RC
          if [[ "${FINAL_RELEASE}" == "false" || "${TOOL_VERSION}" == *alpha* || "${TOOL_VERSION}" == *beta* || "${TOOL_VERSION}" == *RC* ]]; then
            docker tag jaimetur/ssb-retuning-automations:${TOOL_VERSION} jaimetur/ssb-retuning-automations:latest
            docker push jaimetur/ssb-retuning-automations:latest
          fi
      
          # Push 'latest-stable' only if final_release is true AND not alpha/beta/RC
          if [[ "${FINAL_RELEASE}" == "true" && "${TOOL_VERSION}" != *alpha* && "${TOOL_VERSION}" != *beta* && "${TOOL_VERSION}" != *RC* ]]; then
            docker tag jaimetur/ssb-retuning-automations:${TOOL_VERSION} jaimetur/ssb-retuning-automations:latest-stable
            docker push jaimetur/ssb-retuning-automations:latest-stable
          fi
          

      # üê≥ Build & Push Windows Docker image (disabled since this doesn't work as expected)
      - name: üê≥ Build & Push Windows Docker image (disabled since this doesn't work as expected)
        if: ${{ startsWith(matrix.os, 'windows') }}
        shell: bash
        run: |
          # Define FINAL_RELEASE=false con fallback si est√° vac√≠o (por ejemplo, en eventos push)
          FINAL_RELEASE="${{ inputs.final_release }}"
          FINAL_RELEASE=${FINAL_RELEASE:-false}
      
          echo "‚Üí FINAL_RELEASE = $FINAL_RELEASE"
          
          # Construir imagen Windows
          docker build --pull --no-cache \
                -t jaimetur/ssb-retuning-automations:${TOOL_VERSION}-windows \
                -f docker/dockerfile-windows .
          
          # Push siempre etiqueta obligatoria con la versi√≥n
          docker push jaimetur/ssb-retuning-automations:${TOOL_VERSION}-windows
          
          # Push 'latest' if final_release is false OR it's alpha/beta/RC
          if [[ "${FINAL_RELEASE}" == "false" || "${TOOL_VERSION}" == *alpha* || "${TOOL_VERSION}" == *beta* || "${TOOL_VERSION}" == *RC* ]]; then
            docker tag jaimetur/ssb-retuning-automations:${TOOL_VERSION}-windows jaimetur/ssb-retuning-automations:latest-windows
            docker push jaimetur/ssb-retuning-automations:latest-windows
          fi
      
          # Push 'latest-stable' only if final_release is true AND not alpha/beta/RC
          if [[ "${FINAL_RELEASE}" == "true" && "${TOOL_VERSION}" != *alpha* && "${TOOL_VERSION}" != *beta* && "${TOOL_VERSION}" != *RC* ]]; then
            docker tag jaimetur/ssb-retuning-automations:${TOOL_VERSION}-windows jaimetur/ssb-retuning-automations:latest-stable-windows
            docker push jaimetur/ssb-retuning-automations:latest-stable-windows
          fi

      # ================================
      # End of Docker version Generation
      # ================================
