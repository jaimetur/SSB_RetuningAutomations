<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSB Retuning Automations - Administration Panel</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <!-- Admin management dashboard -->
  <main class="container">
    <header class="topbar">
      <div>
        <h1>SSB Retuning Automations - Administration Panel</h1>
        <p>Manage access, passwords, and usage times.</p>
      </div>
      <nav>
        <div class="user-meta">User: <b>{{ user.username }}</b> ({{ user.role }})</div>
        <div class="nav-links">
          <a href="/">Home</a>
          <a href="/logout">Sign out</a>
        </div>
      </nav>
    </header>


    <section class="card">
      <h2>Processing Limits</h2>
      <form method="post" action="/admin/settings" class="inline admin-limits-form">
        <label>Max CPU % <input type="number" name="max_cpu_percent" min="10" max="100" value="{{ admin_settings.max_cpu_percent }}" /></label>
        <label>Max Memory % <input type="number" name="max_memory_percent" min="10" max="100" value="{{ admin_settings.max_memory_percent }}" /></label>
        <label>Max parallel tasks <input type="number" name="max_parallel_tasks" min="1" max="8" value="{{ admin_settings.max_parallel_tasks }}" /></label>
        <button type="submit" class="btn btn-primary">Save limits</button>
      </form>
    </section>

    <section class="card">
      <h2>Create user</h2>
      <form method="post" action="/admin/users/create" class="inline">
        <input type="text" name="username" placeholder="username" required />
        <input type="password" name="password" placeholder="temporary password" required />
        <select name="role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button type="submit">Create</button>
      </form>
    </section>

    <section class="card">
      <div class="runs-header">
        <h2>Users</h2>
        <div class="runs-actions">
          <button type="button" id="toggle_users_panel" class="panel-toggle" aria-label="Collapse users panel" title="Collapse/Expand">▾</button>
        </div>
      </div>
      <div class="table-scroll latest-global-scroll" id="users_panel_table">
      <table>
        <thead><tr><th>User</th><th>Password</th><th>Role</th><th>Status</th><th>Logged time</th><th>Execution time</th><th>Storage</th><th>Actions</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>
                <input type="text" name="username" value="{{ u.username }}" form="update_user_{{ u.id }}" required class="user-input" />
            </td>
            <td>
                <input type="password" name="new_password" placeholder="new password" form="update_user_{{ u.id }}" class="password-input" />
            </td>
            <td>
                <select name="role" form="update_user_{{ u.id }}">
                  <option value="user" {% if u.role == 'user' %}selected{% endif %}>user</option>
                  <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>admin</option>
                </select>
            </td>
            <td>
                <select name="active" form="update_user_{{ u.id }}">
                  <option value="1" {% if u.active %}selected{% endif %}>active</option>
                  <option value="0" {% if not u.active %}selected{% endif %}>inactive</option>
                </select>
            </td>
            <td class="cell-middle">{{ u.total_login_hms }}</td>
            <td class="cell-middle">{{ u.total_execution_hms }}</td>
            <td class="storage-cell cell-middle">{{ u.storage_size }}</td>
            <td>
              <div class="action-row">
                <form method="post" action="/admin/users/{{ u.id }}/clear_storage" class="inline confirm-form" data-confirm="This will delete all Uploads and Exports for this user. Continue?">
                  <button type="submit" class="btn btn-success">Clear storage</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/update" class="inline" id="update_user_{{ u.id }}">
                  <button type="submit" class="btn btn-primary">Update user</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/delete" class="inline confirm-form" data-confirm="This will delete the user and all Uploads/Exports. Continue?">
                  <button type="submit" class="btn btn-danger">Delete user</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </section>

    <section class="card">
      <div class="runs-header">
        <h2>Inputs Repository</h2>
        <div class="runs-actions">
          <span class="runs-total" id="inputs_total_size">Total size: {{ inputs_total_size }}</span>
          <button type="button" id="select_all_inputs">Select All</button>
          <button type="button" id="unselect_all_inputs">Un-Select All</button>
          <button type="button" id="select_older_inputs" class="btn btn-accent">Select Older</button>
          <button type="button" id="delete_selected_inputs" class="btn btn-danger">Delete Selected</button>
          <button type="button" id="toggle_inputs_panel" class="panel-toggle" aria-label="Collapse inputs panel" title="Collapse/Expand">▾</button>
        </div>
      </div>
      <input type="date" id="older_input_date_picker" class="hidden" />
      <div class="table-scroll" id="inputs_panel_table">
      <table>
        <thead><tr><th></th><th>Input</th><th>Uploaded by</th><th>Uploaded at</th><th>Size</th></tr></thead>
        <tbody>
          {% for item in input_items %}
          <tr>
            <td><input type="checkbox" class="input-checkbox" value="{{ item.id }}" data-uploaded-at="{{ item.uploaded_at }}" /></td>
            <td>{{ item.input_name }}</td><td>{{ item.uploaded_by }}</td><td>{{ item.uploaded_at }}</td><td>{{ item.size_mb }}</td>
          </tr>
          {% else %}
          <tr><td colspan="5">No inputs yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </section>

    <section class="card">
      <div class="runs-header">
        <div class="runs-title-row">
          <h2>Latest Global Executions</h2>
        </div>
        <div class="runs-actions">
          <span class="runs-total">Total size: {{ global_runs_size }}</span>
          <button type="button" id="select_all_runs">Select All</button>
          <button type="button" id="unselect_all_runs">Un-Select All</button>
          <button type="button" id="select_older_runs" class="btn btn-accent">Select Older</button>
          <button type="button" id="select_error_runs" class="btn btn-accent">Select Error</button>
          <button type="button" id="delete_selected_runs" class="btn btn-danger">Delete Selected</button>
          <button type="button" id="toggle_runs_panel" class="panel-toggle" aria-label="Collapse runs panel" title="Collapse/Expand">▾</button>
        </div>
      </div>
      <input type="date" id="older_date_picker" class="hidden" />
      <div class="table-scroll" id="runs_panel_table">
      <table>
        <thead><tr><th></th><th>ID</th><th>User</th><th>Module</th><th>Version</th><th>Input</th><th>Status</th><th>Start</th><th>End</th><th>Duration</th><th>Output</th><th>Log</th><th>Size</th></tr></thead>
        <tbody>
          {% for r in recent_runs %}
          <tr class="{% if r.status_lower == 'error' %}run-error{% elif r.status_lower == 'success' %}run-success{% endif %}" data-status="{{ r.status_lower }}">
            <td><input type="checkbox" class="run-checkbox" value="{{ r.id }}" data-start="{{ r.started_at }}" data-status="{{ r.status_lower }}" /></td>
            <td>{{ r.id }}</td>
            <td>{{ r.username }}</td>
            <td>{{ r.module }}</td>
            <td>{{ r.tool_version or '—' }}</td>
            <td>{{ r.input_name or "—" }}</td><td>{{ r.status_display }}</td>
            <td>{{ r.started_at }}</td>
            <td>{{ r.finished_at }}</td>
            <td>{{ r.duration_hms }}</td>
            <td>
              {% if r.output_zip %}
                <a href="/runs/{{ r.id }}/download">Download zip</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              {% if r.output_log_file %}
                <a href="/runs/{{ r.id }}/log">Download log</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ r.size_mb }}</td>
          </tr>
          {% else %}
            <tr><td colspan="13">No runs yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </section>


    <section class="card log-card">
      <div class="log-header">
        <h2>Execution Logs</h2>
        <div class="log-actions">
          <select id="admin_log_run_selector">
            {% for r in recent_runs %}
              <option value="{{ r.id }}" {% if loop.first %}selected{% endif %}>#{{ r.id }} - {{ r.username }} - {{ r.module }} - {{ r.input_name or '—' }}</option>
            {% endfor %}
          </select>
          <button type="button" id="admin_refresh_log">Refresh</button>
          <button type="button" id="admin_clear_log">Clear</button>
          <button type="button" id="admin_copy_log">Copy all</button>
          <button type="button" id="admin_copy_selection">Copy selection</button>
          <button type="button" id="toggle_admin_execution_log_panel" class="panel-toggle" aria-label="Collapse execution log panel" title="Collapse/Expand">▾</button>
        </div>
      </div>
      <pre id="admin_log_output" class="log-output">No logs yet.</pre>
    </section>

    <section class="card log-card">
      <div class="log-header">
        <h2>System Logs</h2>
        <div class="log-actions">
          <select id="admin_system_log_source">
            <option value="app" selected>Application</option>
            <option value="api">API</option>
            <option value="web-access">Web Access</option>
          </select>
          <button type="button" id="admin_refresh_system_log">Refresh</button>
          <button type="button" id="admin_clear_system_log">Clear</button>
          <button type="button" id="admin_copy_system_log">Copy all</button>
          <button type="button" id="admin_copy_system_selection">Copy selection</button>
          <button type="button" id="admin_delete_system_log" class="btn btn-danger">Delete</button>
          <button type="button" id="toggle_admin_system_log_panel" class="panel-toggle" aria-label="Collapse system log panel" title="Collapse/Expand">▾</button>
        </div>
      </div>
      <pre id="admin_system_log_output" class="log-output">No logs yet.</pre>
    </section>


  </main>
  <script>

    function showModal({ title = "Notice", message = "", confirmText = "Accept", cancelText = "" }) {
      return new Promise((resolve) => {
        const backdrop = document.createElement("div");
        backdrop.className = "modal-backdrop";
        const box = document.createElement("div");
        box.className = "modal-box";
        const titleEl = document.createElement("h3");
        titleEl.className = "modal-title";
        titleEl.textContent = title;
        const messageEl = document.createElement("p");
        messageEl.className = "modal-message";
        messageEl.textContent = message;
        const actions = document.createElement("div");
        actions.className = "modal-actions";

        if (cancelText) {
          const cancelBtn = document.createElement("button");
          cancelBtn.type = "button";
          cancelBtn.className = "btn btn-danger";
          cancelBtn.textContent = cancelText;
          cancelBtn.addEventListener("click", () => {
            backdrop.remove();
            resolve(false);
          });
          actions.appendChild(cancelBtn);
        }

        const okBtn = document.createElement("button");
        okBtn.type = "button";
        okBtn.className = "btn btn-primary";
        okBtn.textContent = confirmText;
        okBtn.addEventListener("click", () => {
          backdrop.remove();
          resolve(true);
        });
        actions.appendChild(okBtn);

        box.appendChild(titleEl);
        box.appendChild(messageEl);
        box.appendChild(actions);
        backdrop.appendChild(box);
        document.body.appendChild(backdrop);
      });
    }

    document.querySelectorAll(".confirm-form").forEach((form) => {
      form.addEventListener("submit", async (event) => {
        const message = form.dataset.confirm || "Are you sure?";
        const ok = await showModal({ title: "Please confirm", message, confirmText: "Accept", cancelText: "Cancel" });
        if (!ok) {
          event.preventDefault();
        }
      });
    });

    const selectAllRunsButton = document.getElementById("select_all_runs");
    const unselectAllRunsButton = document.getElementById("unselect_all_runs");
    const selectOlderRunsButton = document.getElementById("select_older_runs");
    const selectErrorRunsButton = document.getElementById("select_error_runs");
    const deleteSelectedRunsButton = document.getElementById("delete_selected_runs");
    const toggleRunsPanelButton = document.getElementById("toggle_runs_panel");
    const runsTable = document.getElementById("runs_panel_table");
    const selectAllInputsButton = document.getElementById("select_all_inputs");
    const unselectAllInputsButton = document.getElementById("unselect_all_inputs");
    const selectOlderInputsButton = document.getElementById("select_older_inputs");
    const deleteSelectedInputsButton = document.getElementById("delete_selected_inputs");
    const olderInputDatePicker = document.getElementById("older_input_date_picker");
    const toggleInputsPanelButton = document.getElementById("toggle_inputs_panel");
    const inputsPanelTable = document.getElementById("inputs_panel_table");
    const toggleUsersPanelButton = document.getElementById("toggle_users_panel");
    const usersPanelTable = document.getElementById("users_panel_table");
    const adminLogRunSelector = document.getElementById("admin_log_run_selector");
    const adminRefreshLogButton = document.getElementById("admin_refresh_log");
    const adminClearLogButton = document.getElementById("admin_clear_log");
    const adminCopyLogButton = document.getElementById("admin_copy_log");
    const adminCopySelectionButton = document.getElementById("admin_copy_selection");
    const toggleAdminExecutionLogPanelButton = document.getElementById("toggle_admin_execution_log_panel");
    const adminLogOutput = document.getElementById("admin_log_output");
    const adminSystemLogSource = document.getElementById("admin_system_log_source");
    const adminRefreshSystemLogButton = document.getElementById("admin_refresh_system_log");
    const adminClearSystemLogButton = document.getElementById("admin_clear_system_log");
    const adminCopySystemLogButton = document.getElementById("admin_copy_system_log");
    const adminCopySystemSelectionButton = document.getElementById("admin_copy_system_selection");
    const adminDeleteSystemLogButton = document.getElementById("admin_delete_system_log");
    const toggleAdminSystemLogPanelButton = document.getElementById("toggle_admin_system_log_panel");
    const adminSystemLogOutput = document.getElementById("admin_system_log_output");

    function getSelectedRunIds() {
      return Array.from(document.querySelectorAll(".run-checkbox:checked")).map((box) => Number(box.value));
    }

    if (selectAllRunsButton) {
      selectAllRunsButton.addEventListener("click", () => {
        document.querySelectorAll(".run-checkbox").forEach((box) => {
          box.checked = true;
        });
      });
    }

    if (unselectAllRunsButton) {
      unselectAllRunsButton.addEventListener("click", () => {
        document.querySelectorAll(".run-checkbox").forEach((box) => {
          box.checked = false;
        });
      });
    }

    function selectErrorRuns() {
      const table = document.querySelector(".latest-global-scroll table");
      const headerCells = table ? table.querySelectorAll("thead th") : [];
      let statusIndex = -1;
      headerCells.forEach((cell, index) => {
        if (cell.textContent.trim().toLowerCase() === "status") {
          statusIndex = index;
        }
      });
      document.querySelectorAll(".run-checkbox").forEach((box) => {
        const row = box.closest("tr");
        const statusColumn = row && statusIndex >= 0 ? row.cells[statusIndex] : null;
        const statusText = statusColumn ? statusColumn.textContent.trim().toLowerCase() : "";
        const statusAttr = (row?.dataset.status || box.dataset.status || "").trim().toLowerCase();
        if (statusText === "error" || statusAttr === "error" || row?.classList.contains("run-error")) {
          box.checked = true;
        }
      });
    }

    if (selectErrorRunsButton) {
      selectErrorRunsButton.addEventListener("click", selectErrorRuns);
    }

    let lastChecked = null;
    document.querySelectorAll(".run-checkbox").forEach((box) => {
      box.addEventListener("click", (event) => {
        if (!event.shiftKey || !lastChecked) {
          lastChecked = box;
          return;
        }
        const checkboxes = Array.from(document.querySelectorAll(".run-checkbox"));
        const start = checkboxes.indexOf(box);
        const end = checkboxes.indexOf(lastChecked);
        const [min, max] = start < end ? [start, end] : [end, start];
        for (let i = min; i <= max; i += 1) {
          checkboxes[i].checked = lastChecked.checked;
        }
      });
    });

    if (selectOlderRunsButton) {
      selectOlderRunsButton.addEventListener("click", () => {
        const picker = document.getElementById("older_date_picker");
        if (picker) {
          picker.showPicker();
        }
      });
    }

    const olderDatePicker = document.getElementById("older_date_picker");
    if (olderDatePicker) {
      olderDatePicker.addEventListener("change", () => {
        const selected = olderDatePicker.value;
        if (!selected) {
          return;
        }
        const threshold = new Date(`${selected}T00:00:00`);
        if (Number.isNaN(threshold.getTime())) {
          return;
        }
        document.querySelectorAll(".run-checkbox").forEach((box) => {
          const startValue = box.dataset.start;
          if (!startValue) {
            return;
          }
          const parts = startValue.split("-");
          const normalized = `${parts[0]}-${parts[1]}-${parts[2]}T${parts[3] || "00:00:00"}`;
          const startDate = new Date(normalized);
          if (!Number.isNaN(startDate.getTime()) && startDate < threshold) {
            box.checked = true;
          }
        });
        olderDatePicker.value = "";
      });
    }

    if (deleteSelectedRunsButton) {
      deleteSelectedRunsButton.addEventListener("click", async () => {
        const ids = getSelectedRunIds();
        if (ids.length === 0) {
          return;
        }
        const ok = await showModal({ title: "Delete executions", message: "This will delete the Uploads and Exports for the selected executions. Continue?", confirmText: "Accept", cancelText: "Cancel" });
        if (!ok) {
          return;
        }
        fetch("/admin/runs/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        }).then(() => window.location.reload());
      });
    }


    function getSelectedInputIds() {
      return Array.from(document.querySelectorAll(".input-checkbox:checked")).map((box) => Number(box.value));
    }
    toggleRunsPanelButton?.addEventListener("click", () => {
      runsTable?.classList.toggle("hidden");
      if (toggleRunsPanelButton) {
        toggleRunsPanelButton.textContent = runsTable?.classList.contains("hidden") ? "▸" : "▾";
      }
    });
    toggleInputsPanelButton?.addEventListener("click", () => {
      inputsPanelTable?.classList.toggle("hidden");
      if (toggleInputsPanelButton) {
        toggleInputsPanelButton.textContent = inputsPanelTable?.classList.contains("hidden") ? "▸" : "▾";
      }
    });
    selectAllInputsButton?.addEventListener("click", () => document.querySelectorAll(".input-checkbox").forEach((b) => { b.checked = true; }));
    unselectAllInputsButton?.addEventListener("click", () => document.querySelectorAll(".input-checkbox").forEach((b) => { b.checked = false; }));
    selectOlderInputsButton?.addEventListener("click", () => olderInputDatePicker?.showPicker());
    olderInputDatePicker?.addEventListener("change", () => {
      const selected = olderInputDatePicker.value;
      if (!selected) return;
      const threshold = new Date(`${selected}T00:00:00`);
      document.querySelectorAll(".input-checkbox").forEach((box) => {
        const raw = box.dataset.uploadedAt || "";
        const d = new Date(raw.replace(/-/g,":"));
        if (!Number.isNaN(d.getTime()) && d < threshold) box.checked = true;
      });
      olderInputDatePicker.value = "";
    });
    deleteSelectedInputsButton?.addEventListener("click", async () => {
      const ids = getSelectedInputIds();
      if (!ids.length) return;
      const ok = await showModal({ title: "Delete inputs", message: "Delete selected inputs?", confirmText: "Accept", cancelText: "Cancel" });
      if (!ok) return;
      fetch("/admin/inputs/delete", {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify({ids})}).then(() => window.location.reload());
    });


    toggleUsersPanelButton?.addEventListener("click", () => {
      usersPanelTable?.classList.toggle("hidden");
      if (toggleUsersPanelButton) {
        toggleUsersPanelButton.textContent = usersPanelTable?.classList.contains("hidden") ? "▸" : "▾";
      }
    });

    function renderAdminLog(text, target) {
      if (!target) return;
      if (!text) {
        target.textContent = "No logs yet.";
        return;
      }
      const lines = text.split(/\r?\n/);
      target.innerHTML = lines.map((line) => {
        let cls = "log-info";
        if (line.includes("[ERROR]")) cls = "log-error";
        else if (line.includes("[WARNING]")) cls = "log-warning";
        else if (line.includes("[DEBUG]")) cls = "log-debug";
        return `<span class="${cls}">${line.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;")}</span>`;
      }).join("\n");
    }

    function copyToClipboard(text) {
      if (!text) return;
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
        return;
      }
      const helper = document.createElement("textarea");
      helper.value = text;
      document.body.appendChild(helper);
      helper.select();
      document.execCommand("copy");
      document.body.removeChild(helper);
    }

    function fetchAdminRunLog() {
      const runId = adminLogRunSelector?.value;
      if (!runId) {
        renderAdminLog("", adminLogOutput);
        return;
      }
      fetch(`/admin/logs/by_run/${runId}`)
        .then((res) => res.json())
        .then((data) => renderAdminLog(data.log || "", adminLogOutput))
        .catch(() => renderAdminLog("", adminLogOutput));
    }

    function fetchAdminSystemLog() {
      const source = adminSystemLogSource?.value || "app";
      fetch(`/logs/system?source=${encodeURIComponent(source)}`)
        .then((res) => res.json())
        .then((data) => renderAdminLog(data.log || "", adminSystemLogOutput))
        .catch(() => renderAdminLog("", adminSystemLogOutput));
    }

    adminLogRunSelector?.addEventListener("change", fetchAdminRunLog);
    adminRefreshLogButton?.addEventListener("click", fetchAdminRunLog);
    adminClearLogButton?.addEventListener("click", () => { if (adminLogOutput) adminLogOutput.textContent = ""; });
    adminCopyLogButton?.addEventListener("click", () => copyToClipboard(adminLogOutput?.textContent || ""));
    adminCopySelectionButton?.addEventListener("click", () => copyToClipboard(window.getSelection()?.toString() || ""));

    adminSystemLogSource?.addEventListener("change", fetchAdminSystemLog);
    adminRefreshSystemLogButton?.addEventListener("click", fetchAdminSystemLog);
    adminClearSystemLogButton?.addEventListener("click", () => { if (adminSystemLogOutput) adminSystemLogOutput.textContent = ""; });
    adminCopySystemLogButton?.addEventListener("click", () => copyToClipboard(adminSystemLogOutput?.textContent || ""));
    adminCopySystemSelectionButton?.addEventListener("click", () => copyToClipboard(window.getSelection()?.toString() || ""));
    adminDeleteSystemLogButton?.addEventListener("click", async () => {
      const ok = await showModal({ title: "Delete system log", message: "Delete all contents from the selected system log file?", confirmText: "Accept", cancelText: "Cancel" });
      if (!ok) return;
      const source = adminSystemLogSource?.value || "app";
      fetch(`/logs/system/delete?source=${encodeURIComponent(source)}`, { method: "POST" })
        .then((res) => res.json())
        .then((data) => { if (data.ok) renderAdminLog("", adminSystemLogOutput); })
        .catch(() => {});
    });

    toggleAdminExecutionLogPanelButton?.addEventListener("click", () => {
      adminLogOutput?.classList.toggle("hidden");
      if (toggleAdminExecutionLogPanelButton) {
        toggleAdminExecutionLogPanelButton.textContent = adminLogOutput?.classList.contains("hidden") ? "▸" : "▾";
      }
    });
    toggleAdminSystemLogPanelButton?.addEventListener("click", () => {
      adminSystemLogOutput?.classList.toggle("hidden");
      if (toggleAdminSystemLogPanelButton) {
        toggleAdminSystemLogPanelButton.textContent = adminSystemLogOutput?.classList.contains("hidden") ? "▸" : "▾";
      }
    });

    fetchAdminRunLog();
    fetchAdminSystemLog();


  </script>
</body>
</html>
