<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSB Retuning Automations - Web Frontend</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <!-- Main dashboard -->
  <main class="container">
    <header class="topbar">
      <div>
        <h1>SSB Retuning Automations - Web Frontend</h1>
        <p>User: <b>{{ user.username }}</b> ({{ user.role }})</p>
      </div>
      <nav>
        {% if user.role == 'admin' %}<a href="/admin">Admin panel</a>{% endif %}
        <a href="/logout">Sign out</a>
      </nav>
    </header>

    <section class="card module-card">
      <div class="module-meta">v{{ tool_meta.version }} - {{ tool_meta.date }}</div>
      <div class="module-header">
        <img class="module-logo" src="/static/logo_02.png" alt="SSB Retuning Automations logo" />
        <div class="module-title">
          <h2>SSB Retuning Automations</h2>
          <p class="module-eyebrow">Web Frontend</p>
          <p class="module-subtitle">1️⃣ Select Module. 2️⃣ Configure Paths & Freqs. 3️⃣ Press Run to execute...</p>
        </div>
        <div class="module-actions">
          <button type="button" class="btn btn-danger" id="change_password_button">Change Password</button>
          <button type="button" class="browse-button" id="load_config_button">Load config.cfg</button>
          <button type="button" class="browse-button" id="export_config_button">Export config.cfg</button>
        </div>
      </div>
      <form action="/run" method="post" class="module-form">
        <div class="form-row">
          <label class="label-wide">Module to execute
            <select name="module" required>
              {% for value, label in module_options %}
                <option value="{{ value }}" {% if settings.get('module') == value %}selected{% endif %}>{{ label }}</option>
              {% endfor %}
            </select>
          </label>
        </div>

        <div class="form-section">
          <p class="section-title">Input folders</p>
          <div class="grid grid-1" id="single-input-row">
            <label>Input
              <span class="input-with-button">
                <input type="text" name="input" id="input_path" value="{{ settings.get('input', '') }}" placeholder="/path/input" />
                <button type="button" class="browse-button upload-button" data-target="input_path" data-file="input_zip" data-kind="input">Upload MOs</button>
              </span>
            </label>
          </div>
          <div class="grid grid-1 hidden" id="prepost-input-rows">
            <label>Input PRE
              <span class="input-with-button">
                <input type="text" name="input_pre" id="input_pre_path" value="{{ settings.get('input_pre', '') }}" />
                <button type="button" class="browse-button upload-button" data-target="input_pre_path" data-file="input_pre_zip" data-kind="input_pre">Upload MOs</button>
              </span>
            </label>
            <label>Input POST
              <span class="input-with-button">
                <input type="text" name="input_post" id="input_post_path" value="{{ settings.get('input_post', '') }}" />
                <button type="button" class="browse-button upload-button" data-target="input_post_path" data-file="input_post_zip" data-kind="input_post">Upload MOs</button>
              </span>
            </label>
          </div>
          <input type="file" id="input_zip" class="hidden" accept=".zip,.log,.txt" multiple />
          <input type="file" id="input_pre_zip" class="hidden" accept=".zip,.log,.txt" multiple />
          <input type="file" id="input_post_zip" class="hidden" accept=".zip,.log,.txt" multiple />
          <input type="file" id="config_picker" class="hidden" accept=".cfg" />
        </div>

        <div class="form-section">
          <p class="section-title">SSB frequencies</p>
          <div class="grid grid-3">
            <label>N77 SSB PRE
              <input type="text" name="n77_ssb_pre" value="{{ settings.get('n77_ssb_pre', '') }}" />
            </label>
            <label>N77 SSB POST
              <input type="text" name="n77_ssb_post" value="{{ settings.get('n77_ssb_post', '') }}" />
            </label>
            <label>N77B SSB
              <input type="text" name="n77b_ssb" value="{{ settings.get('n77b_ssb', '') }}" />
            </label>
          </div>
        </div>

        <div class="form-section">
          <p class="section-title">Allowed SSB and ARFCN lists (comma-separated values)</p>
          <div class="grid grid-2">
            <label>Allowed N77 SSB PRE
              <input type="text" name="allowed_n77_ssb_pre" value="{{ settings.get('allowed_n77_ssb_pre', '') }}" />
            </label>
            <label>Allowed N77 ARFCN PRE
              <input type="text" name="allowed_n77_arfcn_pre" value="{{ settings.get('allowed_n77_arfcn_pre', '') }}" />
            </label>
            <label>Allowed N77 SSB POST
              <input type="text" name="allowed_n77_ssb_post" value="{{ settings.get('allowed_n77_ssb_post', '') }}" />
            </label>
            <label>Allowed N77 ARFCN POST
              <input type="text" name="allowed_n77_arfcn_post" value="{{ settings.get('allowed_n77_arfcn_post', '') }}" />
            </label>
          </div>
        </div>

        <div class="form-section">
          <p class="section-title">Frequency filters</p>
          <div class="freq-selector">
            <div class="freq-fields">
              <label>Configuration Audit filters (empty = no filter)
                <input type="text" name="ca_freq_filters" id="ca_freq_filters" value="{{ settings.get('ca_freq_filters', '') }}" />
              </label>
              <label>Consistency Checks filters (empty = no filter)
                <input type="text" name="cc_freq_filters" id="cc_freq_filters" value="{{ settings.get('cc_freq_filters', '') }}" />
              </label>
            </div>
            <div class="freq-list">
              <label>Network frequencies
                <select id="freq_list" multiple size="10">
                  {% for freq in network_frequencies %}
                    <option value="{{ freq }}">{{ freq }}</option>
                  {% endfor %}
                </select>
              </label>
            </div>
            <div class="freq-buttons">
              <div class="freq-group">
                <p>Configuration Audit</p>
                <button type="button" id="ca_add">Add →</button>
                <button type="button" id="ca_remove">← Remove</button>
                <button type="button" id="ca_clear">Clear</button>
              </div>
              <div class="freq-group">
                <p>Consistency Checks</p>
                <button type="button" id="cc_add">Add →</button>
                <button type="button" id="cc_remove">← Remove</button>
                <button type="button" id="cc_clear">Clear</button>
              </div>
              <button type="button" id="freq_select_all">Select all in list</button>
            </div>
          </div>
          <input type="hidden" name="network_frequencies" id="network_frequencies" value="{{ ','.join(network_frequencies) }}" />
        </div>

        <div class="form-section options-section">
          <p class="section-title">Options</p>
          <div class="grid grid-2">
            <label class="checkbox">
              <input type="checkbox" name="profiles_audit" {% if settings.get('profiles_audit') %}checked{% endif %}>
              Profiles Audit
            </label>
            <label class="checkbox">
              <input type="checkbox" name="frequency_audit" {% if settings.get('frequency_audit') %}checked{% endif %}>
              Frequency Audit
            </label>
            <label class="checkbox">
              <input type="checkbox" name="export_correction_cmd" {% if settings.get('export_correction_cmd') %}checked{% endif %}>
              Export Correction Cmd
            </label>
            <label class="checkbox">
              <input type="checkbox" name="fast_excel_export" {% if settings.get('fast_excel_export') %}checked{% endif %}>
              Fast Excel Export
            </label>
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn btn-success">Run Module</button>
        </div>
      </form>
    </section>

    <section class="card">
      <div class="runs-header">
        <h2>Latest runs</h2>
        <div class="runs-actions">
          <span class="runs-total">Total size: {{ total_runs_size }}</span>
          <button type="button" id="select_all_runs">Select all</button>
          <button type="button" id="unselect_all_runs">Un-select all</button>
          <button type="button" id="delete_selected_runs">Delete selected</button>
        </div>
      </div>
      <table>
        <thead><tr><th></th><th>Module</th><th>Version</th><th>Status</th><th>Start</th><th>End</th><th>Duration (s)</th><th>Output</th><th>Log</th><th>Size</th></tr></thead>
        <tbody>
        {% for r in latest_runs %}
          <tr>
            <td><input type="checkbox" class="run-checkbox" value="{{ r.id }}" /></td>
            <td>{{ r.module }}</td>
            <td>{{ r.tool_version or '—' }}</td>
            <td>{{ r.status }}</td>
            <td>{{ r.started_at }}</td>
            <td>{{ r.finished_at }}</td>
            <td>{{ '%.2f'|format(r.duration_seconds or 0) }}</td>
            <td>
              {% if r.output_zip %}
                <a href="/runs/{{ r.id }}/download">Download zip</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              {% if r.output_log_file %}
                <a href="/runs/{{ r.id }}/log">Download log</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ r.size_mb }}</td>
          </tr>
        {% else %}
          <tr><td colspan="10">No runs yet.</td></tr>
        {% endfor %}
        </tbody>
      </table>
    </section>

    <section class="card log-card">
      <div class="log-header">
        <h2>Log output</h2>
        <div class="log-actions">
          <button type="button" id="refresh_log">Refresh</button>
          <button type="button" id="clear_log">Clear</button>
          <button type="button" id="copy_log">Copy all</button>
          <button type="button" id="copy_selection">Copy selection</button>
        </div>
      </div>
      <pre id="log_output" class="log-output">No logs yet.</pre>
    </section>
  </main>
  <script>
    const moduleSelect = document.querySelector('select[name="module"]');
    const singleInputRow = document.getElementById("single-input-row");
    const prepostInputRows = document.getElementById("prepost-input-rows");

    const uploadInputs = {
      input_zip: document.getElementById("input_zip"),
      input_pre_zip: document.getElementById("input_pre_zip"),
      input_post_zip: document.getElementById("input_post_zip")
    };
    const loadConfigButton = document.getElementById("load_config_button");
    const exportConfigButton = document.getElementById("export_config_button");
    const changePasswordButton = document.getElementById("change_password_button");
    const refreshLogButton = document.getElementById("refresh_log");
    const clearLogButton = document.getElementById("clear_log");
    const copyLogButton = document.getElementById("copy_log");
    const copySelectionButton = document.getElementById("copy_selection");
    const logOutput = document.getElementById("log_output");
    const configPicker = document.getElementById("config_picker");
    const selectAllRunsButton = document.getElementById("select_all_runs");
    const unselectAllRunsButton = document.getElementById("unselect_all_runs");
    const deleteSelectedRunsButton = document.getElementById("delete_selected_runs");

    const inputFields = {
      input: document.getElementById("input_path"),
      input_pre: document.getElementById("input_pre_path"),
      input_post: document.getElementById("input_post_path"),
      n77_ssb_pre: document.querySelector('input[name="n77_ssb_pre"]'),
      n77_ssb_post: document.querySelector('input[name="n77_ssb_post"]'),
      n77b_ssb: document.querySelector('input[name="n77b_ssb"]'),
      allowed_n77_ssb_pre: document.querySelector('input[name="allowed_n77_ssb_pre"]'),
      allowed_n77_arfcn_pre: document.querySelector('input[name="allowed_n77_arfcn_pre"]'),
      allowed_n77_ssb_post: document.querySelector('input[name="allowed_n77_ssb_post"]'),
      allowed_n77_arfcn_post: document.querySelector('input[name="allowed_n77_arfcn_post"]'),
      ca_freq_filters: document.querySelector('input[name="ca_freq_filters"]'),
      cc_freq_filters: document.querySelector('input[name="cc_freq_filters"]'),
      profiles_audit: document.querySelector('input[name="profiles_audit"]'),
      frequency_audit: document.querySelector('input[name="frequency_audit"]'),
      export_correction_cmd: document.querySelector('input[name="export_correction_cmd"]'),
      fast_excel_export: document.querySelector('input[name="fast_excel_export"]')
    };
    const freqList = document.getElementById("freq_list");
    const networkFrequenciesField = document.getElementById("network_frequencies");
    const caFiltersInput = document.getElementById("ca_freq_filters");
    const ccFiltersInput = document.getElementById("cc_freq_filters");
    const caAddButton = document.getElementById("ca_add");
    const caRemoveButton = document.getElementById("ca_remove");
    const caClearButton = document.getElementById("ca_clear");
    const ccAddButton = document.getElementById("cc_add");
    const ccRemoveButton = document.getElementById("cc_remove");
    const ccClearButton = document.getElementById("cc_clear");
    const selectAllButton = document.getElementById("freq_select_all");

    function toggleInputRows() {
      const isConsistencyCheck = moduleSelect.value === "consistency-check";
      singleInputRow.classList.toggle("hidden", isConsistencyCheck);
      prepostInputRows.classList.toggle("hidden", !isConsistencyCheck);
    }

    function uploadZip(files, moduleValue, kindValue) {
      const formData = new FormData();
      Array.from(files).forEach((file) => {
        formData.append("files", file);
      });
      formData.append("module", moduleValue);
      formData.append("kind", kindValue);
      return fetch("/uploads/zip", {
        method: "POST",
        body: formData
      }).then((res) => res.json());
    }

    document.querySelectorAll(".upload-button").forEach((button) => {
      button.addEventListener("click", () => {
        const fileInput = uploadInputs[button.dataset.file];
        if (fileInput) {
          fileInput.click();
        }
      });
    });

    Object.entries(uploadInputs).forEach(([inputId, inputElement]) => {
      inputElement.addEventListener("change", () => {
        const files = inputElement.files;
        if (!files || files.length === 0) {
          return;
        }
        const button = document.querySelector(`[data-file="${inputId}"]`);
        const targetInput = button ? document.getElementById(button.dataset.target) : null;
        const kindValue = button ? button.dataset.kind : "";
        if (!targetInput || !kindValue) {
          return;
        }
        targetInput.value = "Uploading...";
        uploadZip(files, moduleSelect.value, kindValue)
          .then((data) => {
            if (data.ok && data.path) {
              targetInput.value = data.path;
              scheduleAutoSave();
            } else {
              targetInput.value = "";
            }
          })
          .catch(() => {
            targetInput.value = "";
          })
          .finally(() => {
            inputElement.value = "";
          });
      });
    });

    function toBool(value) {
      if (!value) {
        return false;
      }
      return ["true", "1", "yes", "on"].includes(value.toLowerCase());
    }

    function normalizeConfig(config) {
      const source = config.general || config || {};
      const keyMap = {
        last_input_dir: "last_input",
        last_input_dir_audit: "last_input_audit",
        last_input_dir_cc_pre: "last_input_cc_pre",
        last_input_dir_cc_post: "last_input_cc_post",
        last_input_dir_cc_bulk: "last_input_cc_bulk",
        last_input_dir_final_cleanup: "last_input_final_cleanup",
        allowed_n77_ssb_pre_csv: "allowed_n77_ssb_pre",
        allowed_n77_arfcn_pre_csv: "allowed_n77_arfcn_pre",
        allowed_n77_ssb_post_csv: "allowed_n77_ssb_post",
        allowed_n77_arfcn_post_csv: "allowed_n77_arfcn_post"
      };
      const normalized = { ...source };
      Object.entries(keyMap).forEach(([rawKey, logicalKey]) => {
        if (rawKey in source && !(logicalKey in normalized)) {
          normalized[logicalKey] = source[rawKey];
        }
      });
      return normalized;
    }

    function applyConfigValues(config) {
      const general = normalizeConfig(config);
      const moduleValue = moduleSelect.value;
      const inputMappings = {
        "configuration-audit": general.last_input_audit || general.last_input || "",
        "consistency-check-bulk": general.last_input_cc_bulk || general.last_input || "",
        "final-cleanup": general.last_input_final_cleanup || general.last_input || ""
      };

      if (moduleValue === "consistency-check") {
        inputFields.input_pre.value = general.last_input_cc_pre || "";
        inputFields.input_post.value = general.last_input_cc_post || "";
      } else {
        inputFields.input.value = inputMappings[moduleValue] || "";
      }

      inputFields.n77_ssb_pre.value = general.n77_ssb_pre || inputFields.n77_ssb_pre.value;
      inputFields.n77_ssb_post.value = general.n77_ssb_post || inputFields.n77_ssb_post.value;
      inputFields.n77b_ssb.value = general.n77b_ssb || inputFields.n77b_ssb.value;
      inputFields.allowed_n77_ssb_pre.value = general.allowed_n77_ssb_pre || inputFields.allowed_n77_ssb_pre.value;
      inputFields.allowed_n77_arfcn_pre.value = general.allowed_n77_arfcn_pre || inputFields.allowed_n77_arfcn_pre.value;
      inputFields.allowed_n77_ssb_post.value = general.allowed_n77_ssb_post || inputFields.allowed_n77_ssb_post.value;
      inputFields.allowed_n77_arfcn_post.value = general.allowed_n77_arfcn_post || inputFields.allowed_n77_arfcn_post.value;
      inputFields.ca_freq_filters.value = general.ca_freq_filters || inputFields.ca_freq_filters.value;
      inputFields.cc_freq_filters.value = general.cc_freq_filters || inputFields.cc_freq_filters.value;
      inputFields.profiles_audit.checked = toBool(general.profiles_audit);
      inputFields.frequency_audit.checked = toBool(general.frequency_audit);
      inputFields.export_correction_cmd.checked = toBool(general.export_correction_cmd);
      inputFields.fast_excel_export.checked = toBool(general.fast_excel_export);
      if (general.network_frequencies) {
        updateNetworkFrequencies(parseCsv(general.network_frequencies));
      }
    }

    function escapeHtml(text) {
      return text.replace(/[&<>"']/g, (char) => ({
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;"
      }[char]));
    }

    function parseIni(content) {
      const result = {};
      let currentSection = "";
      content.split(/\r?\n/).forEach((line) => {
        const trimmed = line.trim();
        if (!trimmed || trimmed.startsWith(";") || trimmed.startsWith("#")) {
          return;
        }
        const sectionMatch = trimmed.match(/^\[(.+)\]$/);
        if (sectionMatch) {
          currentSection = sectionMatch[1].trim();
          return;
        }
        const equalsIndex = trimmed.indexOf("=");
        if (equalsIndex === -1) {
          return;
        }
        const key = trimmed.slice(0, equalsIndex).trim();
        const value = trimmed.slice(equalsIndex + 1).trim();
        if (!result[currentSection]) {
          result[currentSection] = {};
        }
        result[currentSection][key] = value;
      });
      return result;
    }

    function parseCsv(value) {
      return value
        .split(",")
        .map((item) => item.trim())
        .filter((item) => item);
    }

    function formatCsv(values) {
      const unique = Array.from(new Set(values));
      unique.sort((a, b) => {
        const aNum = Number(a);
        const bNum = Number(b);
        if (!Number.isNaN(aNum) && !Number.isNaN(bNum)) {
          return aNum - bNum;
        }
        return a.localeCompare(b);
      });
      return unique.join(",");
    }

    function getSelectedFrequencies() {
      return Array.from(freqList.selectedOptions).map((option) => option.value);
    }

    function updateNetworkFrequencies(values) {
      if (!values || values.length === 0) {
        return;
      }
      freqList.innerHTML = "";
      values.forEach((value) => {
        const option = document.createElement("option");
        option.value = value;
        option.textContent = value;
        freqList.appendChild(option);
      });
      networkFrequenciesField.value = formatCsv(values);
    }

    function addToFilters(targetInput) {
      const selected = getSelectedFrequencies();
      if (selected.length === 0) {
        return;
      }
      const current = parseCsv(targetInput.value);
      targetInput.value = formatCsv([...current, ...selected]);
      scheduleAutoSave();
    }

    function removeFromFilters(targetInput) {
      const selected = new Set(getSelectedFrequencies());
      if (selected.size === 0) {
        return;
      }
      const current = parseCsv(targetInput.value).filter((value) => !selected.has(value));
      targetInput.value = current.join(",");
      scheduleAutoSave();
    }

    function clearFilters(targetInput) {
      targetInput.value = "";
      scheduleAutoSave();
    }

    function selectAllFrequencies() {
      Array.from(freqList.options).forEach((option) => {
        option.selected = true;
      });
    }

    function renderLog(text) {
      if (!text) {
        logOutput.textContent = "No logs yet.";
        return;
      }
      const lines = text.split(/\r?\n/);
      logOutput.innerHTML = lines.map((line) => {
        let cls = "log-info";
        if (line.includes("[ERROR]")) {
          cls = "log-error";
        } else if (line.includes("[WARNING]")) {
          cls = "log-warning";
        } else if (line.includes("[DEBUG]")) {
          cls = "log-debug";
        }
        return `<span class="${cls}">${escapeHtml(line)}</span>`;
      }).join("\n");
    }

    function fetchLatestLog() {
      fetch("/logs/latest")
        .then((res) => res.json())
        .then((data) => {
          renderLog(data.log || "");
        })
        .catch(() => {
          renderLog("");
        });
    }

    function collectFormValues() {
      const form = document.querySelector(".module-form");
      const data = new FormData(form);
      const payload = {};
      data.forEach((value, key) => {
        payload[key] = value;
      });
      ["profiles_audit", "frequency_audit", "export_correction_cmd", "fast_excel_export"].forEach((key) => {
        payload[key] = form.querySelector(`input[name="${key}"]`).checked;
      });
      return payload;
    }

    let saveTimeout = null;
    function scheduleAutoSave() {
      if (saveTimeout) {
        clearTimeout(saveTimeout);
      }
      saveTimeout = setTimeout(() => {
        fetch("/settings/update", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(collectFormValues())
        }).catch(() => {});
      }, 400);
    }

    document.querySelectorAll(".module-form input, .module-form select").forEach((field) => {
      field.addEventListener("change", scheduleAutoSave);
      field.addEventListener("input", scheduleAutoSave);
    });

    loadConfigButton.addEventListener("click", () => {
      configPicker.click();
    });

    configPicker.addEventListener("change", () => {
      const file = configPicker.files[0];
      if (!file) {
        return;
      }
      const reader = new FileReader();
      reader.onload = () => {
        const parsed = parseIni(reader.result || "");
        applyConfigValues(parsed);
        scheduleAutoSave();
      };
      reader.readAsText(file);
    });

    exportConfigButton.addEventListener("click", () => {
      window.location.href = "/config/export";
    });

    changePasswordButton.addEventListener("click", () => {
      const newPassword = prompt("Enter a new password:");
      if (!newPassword) {
        return;
      }
      fetch("/account/change_password", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ new_password: newPassword })
      }).then((res) => {
        if (res.ok) {
          alert("Password updated. Please sign in again.");
          window.location.href = "/login";
        }
      });
    });

    refreshLogButton.addEventListener("click", fetchLatestLog);
    clearLogButton.addEventListener("click", () => {
      logOutput.textContent = "";
    });

    function copyToClipboard(text) {
      if (!text) {
        return;
      }
      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(text).catch(() => {});
        return;
      }
      const helper = document.createElement("textarea");
      helper.value = text;
      document.body.appendChild(helper);
      helper.select();
      document.execCommand("copy");
      document.body.removeChild(helper);
    }

    copyLogButton.addEventListener("click", () => {
      copyToClipboard(logOutput.textContent || "");
    });

    copySelectionButton.addEventListener("click", () => {
      const selection = window.getSelection();
      if (selection) {
        copyToClipboard(selection.toString());
      }
    });

    caAddButton.addEventListener("click", () => addToFilters(caFiltersInput));
    caRemoveButton.addEventListener("click", () => removeFromFilters(caFiltersInput));
    caClearButton.addEventListener("click", () => clearFilters(caFiltersInput));
    ccAddButton.addEventListener("click", () => addToFilters(ccFiltersInput));
    ccRemoveButton.addEventListener("click", () => removeFromFilters(ccFiltersInput));
    ccClearButton.addEventListener("click", () => clearFilters(ccFiltersInput));
    selectAllButton.addEventListener("click", selectAllFrequencies);

    function getSelectedRunIds() {
      return Array.from(document.querySelectorAll(".run-checkbox:checked")).map((box) => Number(box.value));
    }

    selectAllRunsButton.addEventListener("click", () => {
      document.querySelectorAll(".run-checkbox").forEach((box) => {
        box.checked = true;
      });
    });

    unselectAllRunsButton.addEventListener("click", () => {
      document.querySelectorAll(".run-checkbox").forEach((box) => {
        box.checked = false;
      });
    });

    deleteSelectedRunsButton.addEventListener("click", () => {
      const ids = getSelectedRunIds();
      if (ids.length === 0) {
        return;
      }
      fetch("/runs/delete", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ ids })
      }).then(() => window.location.reload());
    });

    moduleSelect.addEventListener("change", toggleInputRows);
    toggleInputRows();
    document.querySelector(".module-form").addEventListener("submit", () => {
      logOutput.textContent = "";
    });
    fetch("/config/load")
      .then((res) => res.json())
      .then((data) => {
        applyConfigValues(data);
      })
      .catch(() => {});
    fetchLatestLog();
  </script>
</body>
</html>
