<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SSB Retuning Automations - Administration Panel</title>
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <!-- Admin management dashboard -->
  <main class="container">
    <header class="topbar">
      <div>
        <h1>SSB Retuning Automations - Administration Panel</h1>
        <p>Manage access, passwords, and usage times.</p>
      </div>
      <nav>
        <div class="user-meta">User: <b>{{ user.username }}</b> ({{ user.role }})</div>
        <div class="nav-links">
          <a href="/">Home</a>
          <a href="/logout">Sign out</a>
        </div>
      </nav>
    </header>

    <section class="card">
      <h2>Create user</h2>
      <form method="post" action="/admin/users/create" class="inline">
        <input type="text" name="username" placeholder="username" required />
        <input type="password" name="password" placeholder="temporary password" required />
        <select name="role">
          <option value="user">user</option>
          <option value="admin">admin</option>
        </select>
        <button type="submit">Create</button>
      </form>
    </section>

    <section class="card">
      <h2>Users</h2>
      <div class="table-scroll latest-global-scroll">
      <table>
        <thead><tr><th>User</th><th>Password</th><th>Role</th><th>Status</th><th>Logged time</th><th>Execution time</th><th>Storage</th><th>Actions</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>
                <input type="text" name="username" value="{{ u.username }}" form="update_user_{{ u.id }}" required class="user-input" />
            </td>
            <td>
                <input type="password" name="new_password" placeholder="new password" form="update_user_{{ u.id }}" class="password-input" />
            </td>
            <td>
                <select name="role" form="update_user_{{ u.id }}">
                  <option value="user" {% if u.role == 'user' %}selected{% endif %}>user</option>
                  <option value="admin" {% if u.role == 'admin' %}selected{% endif %}>admin</option>
                </select>
            </td>
            <td>
                <select name="active" form="update_user_{{ u.id }}">
                  <option value="1" {% if u.active %}selected{% endif %}>active</option>
                  <option value="0" {% if not u.active %}selected{% endif %}>inactive</option>
                </select>
            </td>
            <td>{{ u.total_login_hms }}</td>
            <td>{{ u.total_execution_hms }}</td>
            <td class="storage-cell">{{ u.storage_size }}</td>
            <td>
              <div class="action-row">
                <form method="post" action="/admin/users/{{ u.id }}/clear_storage" class="inline confirm-form" data-confirm="This will delete all Uploads and Exports for this user. Continue?">
                  <button type="submit" class="btn btn-success">Clear storage</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/update" class="inline" id="update_user_{{ u.id }}">
                  <button type="submit" class="btn btn-primary">Update user</button>
                </form>
                <form method="post" action="/admin/users/{{ u.id }}/delete" class="inline confirm-form" data-confirm="This will delete the user and all Uploads/Exports. Continue?">
                  <button type="submit" class="btn btn-danger">Delete user</button>
                </form>
              </div>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </section>

    <section class="card">
      <div class="runs-header">
        <h2>Latest Global Executions</h2>
        <div class="runs-actions">
          <span class="runs-total">Total size: {{ global_runs_size }}</span>
          <button type="button" id="select_all_runs">Select All</button>
          <button type="button" id="unselect_all_runs">Un-Select All</button>
          <button type="button" id="select_older_runs" class="btn btn-accent">Select Older</button>
          <button type="button" id="select_error_runs" class="btn btn-accent">Select Error</button>
          <button type="button" id="delete_selected_runs" class="btn btn-danger">Delete Selected</button>
        </div>
      </div>
      <input type="date" id="older_date_picker" class="hidden" />
      <div class="table-scroll">
      <table>
        <thead><tr><th></th><th>ID</th><th>User</th><th>Module</th><th>Version</th><th>Status</th><th>Start</th><th>End</th><th>Duration</th><th>Output</th><th>Log</th><th>Size</th></tr></thead>
        <tbody>
          {% for r in recent_runs %}
          <tr class="{% if r.status_lower == 'error' %}run-error{% elif r.status_lower == 'success' %}run-success{% endif %}" data-status="{{ r.status_lower }}">
            <td><input type="checkbox" class="run-checkbox" value="{{ r.id }}" data-start="{{ r.started_at }}" data-status="{{ r.status_lower }}" /></td>
            <td>{{ r.id }}</td>
            <td>{{ r.username }}</td>
            <td>{{ r.module }}</td>
            <td>{{ r.tool_version or '—' }}</td>
            <td>{% if r.status_lower == 'success' %}success{% else %}{{ r.status }}{% endif %}</td>
            <td>{{ r.started_at }}</td>
            <td>{{ r.finished_at }}</td>
            <td>{{ r.duration_hms }}</td>
            <td>
              {% if r.output_zip %}
                <a href="/runs/{{ r.id }}/download">Download zip</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>
              {% if r.output_log_file %}
                <a href="/runs/{{ r.id }}/log">Download log</a>
              {% else %}
                —
              {% endif %}
            </td>
            <td>{{ r.size_mb }}</td>
          </tr>
          {% else %}
            <tr><td colspan="12">No runs yet.</td></tr>
          {% endfor %}
        </tbody>
      </table>
      </div>
    </section>
  </main>
  <script>
    document.querySelectorAll(".confirm-form").forEach((form) => {
      form.addEventListener("submit", (event) => {
        const message = form.dataset.confirm || "Are you sure?";
        if (!confirm(message)) {
          event.preventDefault();
        }
      });
    });

    const selectAllRunsButton = document.getElementById("select_all_runs");
    const unselectAllRunsButton = document.getElementById("unselect_all_runs");
    const selectOlderRunsButton = document.getElementById("select_older_runs");
    const selectErrorRunsButton = document.getElementById("select_error_runs");
    const deleteSelectedRunsButton = document.getElementById("delete_selected_runs");

    function getSelectedRunIds() {
      return Array.from(document.querySelectorAll(".run-checkbox:checked")).map((box) => Number(box.value));
    }

    if (selectAllRunsButton) {
      selectAllRunsButton.addEventListener("click", () => {
        document.querySelectorAll(".run-checkbox").forEach((box) => {
          box.checked = true;
        });
      });
    }

    if (unselectAllRunsButton) {
      unselectAllRunsButton.addEventListener("click", () => {
        document.querySelectorAll(".run-checkbox").forEach((box) => {
          box.checked = false;
        });
      });
    }

    function selectErrorRuns() {
      const table = document.querySelector(".latest-global-scroll table");
      const headerCells = table ? table.querySelectorAll("thead th") : [];
      let statusIndex = -1;
      headerCells.forEach((cell, index) => {
        if (cell.textContent.trim().toLowerCase() === "status") {
          statusIndex = index;
        }
      });
      document.querySelectorAll(".run-checkbox").forEach((box) => {
        const row = box.closest("tr");
        const statusColumn = row && statusIndex >= 0 ? row.cells[statusIndex] : null;
        const statusText = statusColumn ? statusColumn.textContent.trim().toLowerCase() : "";
        const statusAttr = (row?.dataset.status || box.dataset.status || "").trim().toLowerCase();
        if (statusText === "error" || statusAttr === "error" || row?.classList.contains("run-error")) {
          box.checked = true;
        }
      });
    }

    if (selectErrorRunsButton) {
      selectErrorRunsButton.addEventListener("click", selectErrorRuns);
    }

    let lastChecked = null;
    document.querySelectorAll(".run-checkbox").forEach((box) => {
      box.addEventListener("click", (event) => {
        if (!event.shiftKey || !lastChecked) {
          lastChecked = box;
          return;
        }
        const checkboxes = Array.from(document.querySelectorAll(".run-checkbox"));
        const start = checkboxes.indexOf(box);
        const end = checkboxes.indexOf(lastChecked);
        const [min, max] = start < end ? [start, end] : [end, start];
        for (let i = min; i <= max; i += 1) {
          checkboxes[i].checked = lastChecked.checked;
        }
      });
    });

    if (selectOlderRunsButton) {
      selectOlderRunsButton.addEventListener("click", () => {
        const picker = document.getElementById("older_date_picker");
        if (picker) {
          picker.showPicker();
        }
      });
    }

    const olderDatePicker = document.getElementById("older_date_picker");
    if (olderDatePicker) {
      olderDatePicker.addEventListener("change", () => {
        const selected = olderDatePicker.value;
        if (!selected) {
          return;
        }
        const threshold = new Date(`${selected}T00:00:00`);
        if (Number.isNaN(threshold.getTime())) {
          return;
        }
        document.querySelectorAll(".run-checkbox").forEach((box) => {
          const startValue = box.dataset.start;
          if (!startValue) {
            return;
          }
          const parts = startValue.split("-");
          const normalized = `${parts[0]}-${parts[1]}-${parts[2]}T${parts[3] || "00:00:00"}`;
          const startDate = new Date(normalized);
          if (!Number.isNaN(startDate.getTime()) && startDate < threshold) {
            box.checked = true;
          }
        });
        olderDatePicker.value = "";
      });
    }

    if (deleteSelectedRunsButton) {
      deleteSelectedRunsButton.addEventListener("click", () => {
        const ids = getSelectedRunIds();
        if (ids.length === 0) {
          return;
        }
        if (!confirm("This will delete the Uploads and Exports for the selected executions. Continue?")) {
          return;
        }
        fetch("/admin/runs/delete", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ ids })
        }).then(() => window.location.reload());
      });
    }
  </script>
</body>
</html>
